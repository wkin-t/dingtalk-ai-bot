services:
  # æœåŠ¡ 1: v2rayA (ç§‘å­¦ä¸Šç½‘ç½‘å…³)
  v2raya:
    image: mzz2017/v2raya:latest  # Docker ä¼šä¼˜å…ˆä½¿ç”¨ä½  load è¿›å»çš„æœ¬åœ°é•œåƒï¼Œä¸ä¼šå»æ‹‰å–
    container_name: v2raya
    restart: always
    privileged: true       # v2rayA éœ€è¦æƒé™æ“ä½œå†…æ ¸ç½‘ç»œ
    network_mode: "host"   # ã€å…³é”®ã€‘ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼Œç›´æ¥ç›‘å¬ 10809 å’Œ 2017
    environment:
      - V2RAYA_LOG_FILE=/tmp/v2raya.log
    volumes:
      - /lib/modules:/lib/modules:ro
      - /etc/resolv.conf:/etc/resolv.conf
      - /etc/v2raya:/etc/v2raya  # ä½ çš„èŠ‚ç‚¹è®¢é˜…ä¿¡æ¯ä¼šå­˜åœ¨è¿™é‡Œ
    deploy:
      resources:
        limits:
          memory: 512M  # é™åˆ¶è¯¥å®¹å™¨æœ€å¤šç”¨ 512M

  # === æ–°å¢ Tailscale æœåŠ¡ ===
  tailscaled:
    image: tailscale/tailscale:latest
    container_name: tailscaled
    hostname: tencent-docker  # ç»™ä½ çš„æœºå™¨èµ·ä¸ªåå­—ï¼Œåœ¨æ§åˆ¶å°æ˜¾ç¤º
    restart: always
    network_mode: "host"            # å¿…é¡»ç”¨ host æ¨¡å¼æ‰èƒ½è®¿é—®å®¿ä¸»æœºç½‘ç»œ
    privileged: true                # å¿…é¡»ç»™ç‰¹æƒ
    cap_add:                        # å¿…é¡»æ·»åŠ ç½‘ç»œç®¡ç†æƒé™
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./tailscale_data:/var/lib/tailscale # æ•°æ®æŒä¹…åŒ–åˆ°å½“å‰ç›®å½•
      - /dev/net/tun:/dev/net/tun           # å¿…é¡»æŒ‚è½½ tun è®¾å¤‡
    environment:
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      # Tailscale Auth Key (ä» .env æˆ–ç¯å¢ƒå˜é‡è¯»å–)
      - TS_AUTHKEY=${TS_AUTHKEY}
      # ğŸ‘‡ æ”¹å› 127.0.0.1 (å¯¹åº” v2rayA çš„ç«¯å£ 1087/1080)
      - ALL_PROXY=socks5://127.0.0.1:1080
      - HTTP_PROXY=http://127.0.0.1:1087
      - HTTPS_PROXY=http://127.0.0.1:1087
    deploy:
      resources:
        limits:
          memory: 512M  # é™åˆ¶è¯¥å®¹å™¨æœ€å¤šç”¨ 512M

  # === æ–°å¢ï¼šGemini Proxy æœåŠ¡ ===
  gemini-app:
    build: .                # å…³é”®ï¼šå‘Šè¯‰ Docker ä½¿ç”¨å½“å‰ç›®å½•çš„ Dockerfile æ„å»ºé•œåƒ
    container_name: gemini-app
    restart: always
    # ä½¿ç”¨ host æ¨¡å¼ï¼Œè¿™æ ·å¯ä»¥ç›´æ¥è®¿é—®å®¿ä¸»æœºçš„ v2rayA ä»£ç† (127.0.0.1:1087)
    # åŒæ—¶ä¹Ÿç›´æ¥ç›‘å¬å®¿ä¸»æœºçš„ 35000 ç«¯å£ï¼Œä¸éœ€è¦ ports æ˜ å°„
    network_mode: "host"
    
    # åŠ è½½ .env æ–‡ä»¶é‡Œçš„ç¯å¢ƒå˜é‡ (API Key, Secret ç­‰)
    env_file:
      - .env
      
    depends_on:
      - v2raya              # é€»è¾‘ä¾èµ–ï¼šè™½ç„¶ç½‘ç»œæ˜¯ç‹¬ç«‹çš„ï¼Œä½†å»ºè®®ç­‰ v2rayA èµ·æ¥å†å¯åŠ¨
      
    deploy:
      resources:
        limits:
          memory: 512M  # é™åˆ¶è¯¥å®¹å™¨æœ€å¤šç”¨ 512M

  hbbs:
    container_name: hbbs
    image: rustdesk/rustdesk-server:latest
    command: hbbs -r 127.0.0.1:21117 -k _
    volumes:
      - ./data:/root
    network_mode: "host"
    restart: unless-stopped

  hbbr:
    container_name: hbbr
    image: rustdesk/rustdesk-server:latest
    command: hbbr
    volumes:
      - ./data:/root
    network_mode: "host"
    restart: unless-stopped

  # === å®‰å…¨ç»„ Webhook æœåŠ¡ ===
  # æ•æ„Ÿä¿¡æ¯å·²ç§»è‡³ .env.sg-webhook æ–‡ä»¶
  sg-webhook:
    build:
      context: ./webhook_sg
    container_name: sg-webhook
    restart: always
    ports:
      - "127.0.0.1:35555:35555"
    env_file:
      - .env.sg-webhook
    deploy:
      resources:
        limits:
          memory: 256M